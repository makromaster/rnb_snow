name: Windows Build and Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Test GUI imports
      run: |
        python -c "import tkinter; print('tkinter available')"
        python -c "import sqlite3; print('sqlite3 available')"
        python -c "import selenium; print('selenium available')"

    - name: Run basic functionality tests
      run: |
        python -c "import create_database; print('Database module imports successfully')"
        python -c "import gui_main; print('GUI module imports successfully')"

    - name: Package application files
      run: |
        mkdir dist
        copy *.py dist\
        copy requirements.txt dist\
        copy README.md dist\
        copy *.csv dist\ 2>nul || echo "No CSV files to copy"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rnb-snow-windows
        path: dist/

    - name: Push to private repository
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      env:
        PRIVATE_REPO_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

        # Clone the private repository
        git clone https://${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/makromaster/rnb-snow-builds.git private-repo

        # Copy files to private repo
        xcopy dist private-repo\ /E /Y

        # Commit and push to private repo
        cd private-repo
        git add .
        git commit -m "Automated build from main branch - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" || echo "No changes to commit"
        git push origin main